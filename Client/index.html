<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home automation</title>
</head>

<body>
    <div id="container">

    </div>
    <script>
        window.addEventListener("load", () => {
            const host = "192.168.1.10"
            const port = "80"
            const container = document.getElementById("container")
            let gpo_btn = [null, null, null, null, null, null, null, null, null, null]



            render(container, gpo_btn, host, port)

        })

        function render(container, gpo_btn, host, port) {
            let pin_status = []
            fetch(`http://${host}:${port}/out_stat`)
                .then(response => {
                    return response.json();
                })
                .then(data => {
                    console.log("Fetched data:", data);
                    pin_status = data.status
                    for (let i = 0; i < gpo_btn.length; i++) {
                        container.innerHTML += `
                            <div class="gpo_btn_container">
                                <button id="gpo_btn${i}">${pin_status[i] == 1 ? "Off" : "On"}</button>
                            </div>
                            `
                    }

                    handle_gpo_btn(gpo_btn, host, port)
                })
                .catch(error => {
                    console.error("An error occurred:", error);
                });

        }
        function handle_gpo_btn(gpo_btn, host, port) {
            for (let i = 0; i < gpo_btn.length; i++) {
                let gpo_btn = document.getElementById(`gpo_btn${i}`)
                gpo_btn[i] = gpo_btn
                gpo_btn[i].addEventListener("click", () => {
                    if (gpo_btn[i].innerText == 'On') {
                        fetch(`http://${host}:${port}/gpio?pin_no=${i}&pin_status=on`)
                            .then(response => {
                                return response.json();
                            })
                            .then(data => {
                                console.log("Fetched data:", data);
                                if (data.status) {
                                    gpo_btn[i].innerText = "Off"
                                }
                            })
                            .catch(error => {
                                console.error("An error occurred:", error);
                            });

                    }
                    else {
                        fetch(`http://${host}:${port}/gpio?pin_no=${i}&pin_status=off`)
                            .then(response => {
                                return response.json();
                            })
                            .then(data => {
                                console.log("Fetched data:", data);
                                if (data.status) {
                                    gpo_btn[i].innerText = "On"
                                }
                            })
                            .catch(error => {
                                console.error("An error occurred:", error);
                            });

                    }

                })
            }
        }

    </script>
</body>

</html>